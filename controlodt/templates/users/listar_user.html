{% extends 'base.html'  %}

{% block content %}
<section class=" text-neutral-900">

  <div class="max-w-auto mx-auto px-2 py-6">
    <div class="mb-6">
      <h1 class="text-2xl md:text-3xl font-primary ">Registro de Usuarios</h1>
      <p class="text-neutral-500 text-sm">Total: {{ total }}</p>
    </div>
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
     
      <!-- Filtros -->
      <form method="get" class="w-full sm:w-auto">
        <div class="flex flex-col md:flex-row gap-3">
          <div class="flex-1 w-auto md:w-120">
            <label class="block text-sm font-medium mb-1">Buscar</label>
            <input name="q" value="{{ q }}"
                   class="w-full h-11 rounded-md border bg-neutral-100 border-neutral-300 px-3 focus:outline-none focus:ring-2 focus:ring-neutral-900"
                   placeholder="Nombre, apellido, email o DNI" />
          </div>

          <div>
            <label class="block w-auto  text-sm font-medium mb-1">Estado</label>
            <select name="estado"
                    class="h-11 w-full rounded-md border bg-neutral-100 border-neutral-300 px-3 focus:outline-none focus:ring-2 focus:ring-neutral-900">
              <option value="todos" {% if estado == 'todos' %}selected{% endif %}>Todos</option>
              <option value="activos" {% if estado == 'activos' %}selected{% endif %}>Activos</option>
              <option value="inactivos" {% if estado == 'inactivos' %}selected{% endif %}>Inactivos</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Por página</label>
            <select name="per_page" class="h-11 w-full rounded-md border bg-neutral-100 border-neutral-300 px-3 focus:outline-none focus:ring-2 focus:ring-neutral-900">
              {% for n in per_page_options %}
              <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="md:self-end">
            <button type="submit"
                    class="mb-1 md:mb-0  inline-flex w-full md:w-auto items-center justify-center h-11 px-5 rounded-md bg-amber-500 text-white font-semibold hover:opacity-90">
              Filtrar
            </button>
            <a href="{% url 'user_create' %}?next={{ request.get_full_path|urlencode }}" class="md:w-auto mb-1 md:mb-0  w-full inline-flex items-center h-11 px-4 rounded-md bg-green-500 text-white font-semibold hover:opacity-90">
              Nuevo usuario
            </a>
            <a href="{% url 'group_list' %}" class="mb-1 md:mb-0  w-full md:w-auto inline-flex items-center h-11 px-4 rounded-md bg-slate-900 text-white font-semibold hover:opacity-90">
              Listar Grupos
            </a>
          </div>
         
        </div>

      </form>
    </div>

    

    <!-- Tabla -->
    <div class="mt-2 overflow-x-auto">
      <table class="min-w-full border border-neutral-200 bg-neutral-100 rounded-md overflow-hidden">
        <thead class="bg-slate-900">
          <tr class="text-left text-sm text-neutral-100">
            <th class="px-4 py-3 w-10 ">N°</th>
            <th class="px-4 py-3 w-72 ">Nombre Usuario</th>
            <th class="px-4 py-3">Carnet Id.</th>
            <th class="px-4 py-3">Teléfono</th>
            <th class="px-4 py-3">Rol o Grupo </th>
            <th class="px-4 py-3">Estado</th>
            <th class="px-4 py-3 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-neutral-50">
          {% for u in page_obj.object_list %}
          <tr class="text-sm hover:bg-neutral-200">
            <td class=" text-center font-medium ">{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-3">
                {% if u.imagen %}
                  <img src="{{ u.imagen.url }}" class="h-9 w-9 rounded-full object-cover" alt="">
                {% else %}
                  <div class="h-9 w-9 rounded-full bg-neutral-200 flex items-center justify-center">
                    <span class="text-xs font-semibold">{{ u.nombre|first }}{{ u.apellido|first }}</span>
                  </div>
                {% endif %}
                <div>
                  <div class="font-semibold">{{ u.get_full_name }}</div>
                  <div class="text-neutral-500">{{ u.email }}</div>
                </div>
              </div>
            </td>
            
            <td class="px-4 py-3">{{ u.dni|default:"—" }}</td>
            <td class="px-4 py-3">{{ u.telefono|default:"—" }}</td>
            <td class="px-4 py-3">
              {% if u.groups.all %}
                {% for group in u.groups.all %}
                  {{ group.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% else %}
                —
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if u.is_active %}
                <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-semibold bg-green-50 text-green-700 border border-green-200">
                  <span class="h-1.5 w-1.5 rounded-full bg-green-500"></span> Activo
                </span>
              {% else %}
                <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-semibold bg-amber-50 text-amber-800 border border-amber-200">
                  <span class="h-1.5 w-1.5 rounded-full bg-amber-500"></span> Inactivo
                </span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center justify-end gap-2">
                <!-- Editar (ajusta URL si usas admin) -->
                <a href="{% url 'user_edit' u.pk %}"
                   class="inline-flex items-center h-9 px-3 text-white rounded-lg  bg-amber-300 hover:bg-amber-400">
                  <svg class="md:size-5 size-4  dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                  </svg>

                </a>

                <!-- Activar/Desactivar -->
                <button
                  type="button"
                  class="inline-flex items-center text-xs md:text-ms h-9 px-3 rounded-lg
                         {% if u.is_active %} border bg-red-500 text-white hover:bg-red-600
                         {% else %} bg-green-500 text-white hover:bg-green-600 {% endif %}"
                  data-url="{% url 'user_toggle_active' u.pk %}"
                  data-name="{{ u.get_full_name }}"
                  data-action="{% if u.is_active %}dar de baja{% else %}activar{% endif %}">
                  {% if u.is_active %}
                  <svg class="md:size-5 size-4  text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12h4M4 18v-1a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1Zm8-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                  </svg>

                  {% else %}
                  <svg class="md:size-5 size-4  text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12h4m-2 2v-4M4 18v-1a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1Zm8-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                  </svg>
                 
                  {% endif %}
                </button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-neutral-500">
              No se encontraron usuarios con esos filtros.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    {% if page_obj.paginator.num_pages > 1 %}
    <div class="mt-6 flex items-center justify-between">
      <div class="text-sm text-neutral-600">
        {% comment %} Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }} {% endcomment %}
      </div>
      <div class="flex items-center gap-1">
        {% if page_obj.has_previous %}
          <a class="px-3 h-10 inline-flex items-center rounded-lg bg-slate-600 text-white"
             href="?q={{ q }}&estado={{ estado }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">Anterior</a>
        {% else %}
          <span class="px-3 h-10 inline-flex items-center rounded-lg border bg-slate-800 text-neutral-100">Anterior</span>
        {% endif %}

        {% for i in page_obj.paginator.page_range %}
          {% if i == page_obj.number %}
            <span class="px-3 h-10 inline-flex items-center rounded-lg border border-neutral-900 bg-neutral-900 text-white">{{ i }}</span>
          {% else %}
            <a class="px-3 h-10 inline-flex items-center rounded-lg bg-slate-600 text-white"
               href="?q={{ q }}&estado={{ estado }}&per_page={{ per_page }}&page={{ i }}">{{ i }}</a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <a class="px-3 h-10 inline-flex items-center rounded-lg bg-slate-600 text-white"
             href="?q={{ q }}&estado={{ estado }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Siguiente</a>
        {% else %}
          <span class="px-3 h-10 inline-flex items-center rounded-lg border bg-slate-800 text-neutral-100">Siguiente</span>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Modal de confirmación -->
  <div id="confirmModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>

    <div class="relative mx-auto mt-28 w-full max-w-md px-4">
      <div class="rounded-2xl bg-white border border-neutral-200 shadow-xl overflow-hidden">
        <div class="px-5 py-4 border-b">
          <h3 class="font-semibold" id="modalTitle">Confirmar acción</h3>
        </div>
        <div class="px-5 py-4 text-neutral-700">
          <p id="modalText">¿Seguro que deseas continuar?</p>
        </div>
        <div class="px-5 py-4 flex items-center justify-end gap-2 border-t">
          <button id="cancelBtn"
                  class="h-10 px-4 rounded-lg border border-neutral-300 hover:bg-neutral-100">Cancelar</button>

          <form id="confirmForm" method="post" action="#">
            {% csrf_token %}
            <input type="hidden" name="next" value="?q={{ q }}&estado={{ estado }}&per_page={{ per_page }}&page={{ page_obj.number }}">
            <button type="submit"
                    id="confirmBtn"
                    class="h-10 px-4 rounded-lg bg-neutral-900 text-white font-semibold hover:opacity-90">
              Confirmar
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById('confirmModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmForm = document.getElementById('confirmForm');
    const modalTitle = document.getElementById('modalTitle');
    const modalText = document.getElementById('modalText');

    function openModal(url, name, action) {
      confirmForm.action = url;
      modalTitle.textContent = action.charAt(0).toUpperCase() + action.slice(1);
      modalText.textContent = `¿Seguro que deseas ${action} al usuario "${name}"?`;
      modal.classList.remove('hidden');
    }

    function closeModal() {
      modal.classList.add('hidden');
    }

    cancelBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      closeModal();
    });

    // Delegación: botones Activar/Dar de baja
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-url]');
      if (!btn) return;
      e.preventDefault();
      const url = btn.getAttribute('data-url');
      const name = btn.getAttribute('data-name');
      const action = btn.getAttribute('data-action');
      openModal(url, name, action);
    });

    // Cerrar modal haciendo click en overlay
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
  </script>
</section>
{% endblock %}