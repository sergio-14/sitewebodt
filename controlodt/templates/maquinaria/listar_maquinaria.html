{% extends 'base.html' %}
{% block content %}
<section class="text-neutral-900">
  <div class="max-w-auto mx-auto px-2 py-6">
    <div class="mb-6 flex flex-col gap-3
              md:flex-row items-center justify-between">
      <div>
        <h1 class="text-2xl font-primary">Equipo de Trabajo</h1>
        <p class="text-neutral-500 text-sm">Total: {{ total }}</p>
      </div>
      <div class="flex gap-2">
        <a href="{% url 'maquinaria_create' %}?next={{ request.get_full_path|urlencode }}" class="h-11 py-2 px-4 rounded-md bg-green-500 text-white">+ Nueva maquinaria</a>
      </div>
    </div>

    <form method="get" class="mb-1  p-4 md:p-6 rounded-2xl shadow-sm border border-neutral-100">
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4 items-end">
    
    <div class="lg:col-span-4">
      <label class="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-1 ml-1">Buscar Equipo</label>
      <div class="relative">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-neutral-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </span>
        <input name="q" placeholder="Nombre, cÃ³digo o descripciÃ³n..." value="{{ q }}"
               class="w-full h-12 pl-10 pr-4 rounded-xl border-none bg-neutral-100 focus:bg-white focus:ring-2 focus:ring-red-500 transition-all outline-none text-sm shadow-inner" />
      </div>
    </div>

    <div class="lg:col-span-2">
      <label class="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-1 ml-1">LÃ­nea</label>
      <select name="tipo" class="w-full h-12 rounded-xl border-none bg-neutral-100 focus:bg-white focus:ring-2 focus:ring-red-500 transition-all outline-none text-sm cursor-pointer shadow-inner px-3">
        <option value="">Todas las lÃ­neas</option>
        {% for t in tipos %}
          <option value="{{ t.pk }}" {% if tipo_selected|default:'' == t.pk|stringformat:'s' %}selected{% endif %}>{{ t.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="lg:col-span-2">
      <label class="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-1 ml-1">Estado</label>
      <select name="estado" class="w-full h-12 rounded-xl border-none bg-neutral-100 focus:bg-white focus:ring-2 focus:ring-red-500 transition-all outline-none text-sm cursor-pointer shadow-inner px-3">
        <option value="">Todos los estados</option>
        <option value="OPERATIVA" {% if estado_selected == 'OPERATIVA' %}selected{% endif %}>ðŸŸ¢ Operativa</option>
        <option value="MANTENIMIENTO" {% if estado_selected == 'MANTENIMIENTO' %}selected{% endif %}>ðŸŸ¡ MantenciÃ³n</option>
        <option value="FUERA_SERVICIO" {% if estado_selected == 'FUERA_SERVICIO' %}selected{% endif %}>ðŸ”´ Fuera servicio</option>
        <option value="DADO_BAJA" {% if estado_selected == 'DADO_BAJA' %}selected{% endif %}>âšª Dado baja</option>
      </select>
    </div>

    <div class="lg:col-span-2">
      <label class="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-1 ml-1">Ver</label>
      <select name="per_page" class="w-full h-12 rounded-xl border-none bg-neutral-100 focus:bg-white focus:ring-2 focus:ring-red-500 transition-all outline-none text-sm cursor-pointer shadow-inner px-3 text-center">
        {% for n in per_page_options %}
          <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }} registros</option>
        {% endfor %}
      </select>
    </div>

    <div class="lg:col-span-2">
      <button type="submit" 
              class="w-full h-12 rounded-xl bg-amber-500 text-white font-bold text-sm shadow-lg hover:shadow-red-200/50 transition-all active:scale-95 flex items-center justify-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
        Filtrar
      </button>
    </div>

  </div>
</form>

    <div class="mt-2 overflow-x-auto">
      <table class="min-w-full border border-neutral-200 bg-neutral-100 rounded-md overflow-hidden">
        <thead class="bg-slate-900 text-white">
          <tr class="text-left text-sm">
            <th class="px-4 py-3">#</th>
            <th class="px-4 py-3">Tipo</th>
            <th class="px-4 py-3">Nombre</th>
            <th class="px-4 py-3">CÃ³digo</th>
            <th class="px-4 py-3">Responsable</th>
         
            <th class="px-4 py-3 text-center"> Estado - Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-neutral-50">
          {% for m in page_obj.object_list %}
          <tr class="hover:bg-neutral-200 text-xs">
            <td class="px-4 py-3">{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td class="px-4 py-3 whitespace-nowrap">{{ m.tipo.nombre }}</td>
            <td class="px-4 py-3">{{ m.nombre }}</td>
            <td class="px-4 py-3">{{ m.codigo }}</td>
            <td class="px-4 py-3  whitespace-nowrap">{% if m.responsable %} {{ m.responsable.get_full_name }}{% else %}&mdash;{% endif %}</td>
            
            <td class="px-4 py-3 text-right whitespace-nowrap flex items-center justify-end gap-3">
              <form action="{% url 'cambiar_estado_maquinaria' m.pk %}" method="POST" class="flex items-center gap-2">
                    {% csrf_token %}
                    <select name="nuevo_estado" class="block w-44 pl-3 pr-10 py-1 text-xs bg-white border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md">
                        {% for val, label in m.Estado.choices %}
                            <option value="{{ val }}" {% if m.estado == val %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white  py-2.5 px-3 rounded-md shadow-sm transition-colors" title="Guardar cambios" onclick="return confirm('Â¿EstÃ¡s seguro de que deseas cambiar el estado?')">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                      </svg>
                    </button>
                </form>
              <a href="{% url 'maquinaria_edit' m.pk %}?next={{ request.get_full_path|urlencode }}" class="inline-flex items-center h-9 px-3 rounded-lg bg-amber-300 text-white">
                <svg class="md:size-5 size-4  text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                  </svg>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="px-4 py-8 text-center text-neutral-500">No hay maquinarias.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Reusa paginaciÃ³n igual que en tipos -->
    {% if page_obj.paginator.num_pages > 1 %}
      <div class="mt-4">
        <div class="flex items-center gap-2">
          {% if page_obj.has_previous %}
            <a href="?q={{ q }}&tipo={{ tipo_selected }}&estado={{ estado_selected }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}" class="px-3 h-10 inline-flex items-center rounded-lg bg-slate-600 text-white">Anterior</a>
          {% else %}
            <span class="px-3 h-10 inline-flex items-center rounded-lg border bg-slate-800 text-neutral-100">Anterior</span>
          {% endif %}
          {% for i in page_obj.paginator.page_range %}
            {% if i == page_obj.number %}
              <span class="px-3 h-10 inline-flex items-center rounded-lg border border-neutral-900 bg-neutral-900 text-white">{{ i }}</span>
            {% else %}
              <a class="px-3 h-10 inline-flex items-center rounded-lg bg-slate-600 text-white" href="?q={{ q }}&tipo={{ tipo_selected }}&estado={{ estado_selected }}&per_page={{ per_page }}&page={{ i }}">{{ i }}</a>
            {% endif %}
          {% endfor %}
          {% if page_obj.has_next %}
            <a class="px-3 h-10 inline-flex items-center rounded-lg bg-slate-600 text-white" href="?q={{ q }}&tipo={{ tipo_selected }}&estado={{ estado_selected }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Siguiente</a>
          {% else %}
            <span class="px-3 h-10 inline-flex items-center rounded-lg border bg-slate-800 text-neutral-100">Siguiente</span>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}
