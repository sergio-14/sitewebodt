{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="text-neutral-900">
  <div class="mx-auto px-4 py-6 max-w-4xl">

    <!-- Estilos espec√≠ficos para la vista detalle (mantienen look de reporte/imprimible) -->
    <style>
      /* Reset peque√±o local para evitar conflictos */
      .report * { box-sizing: border-box; }

      .report-body { font-family: Arial, sans-serif; font-size: 10pt; color: #1f2937; line-height: 1.4; }
      .report-container { padding: 12px 14px; }

      .header-table { width: 100%; border: none; margin-bottom: 6px; }
      .logo-img { width: 90pt; height: auto; }
      .company-title { font-size: 16pt; font-weight: bold; color: #3d4f2a; }
      .company-subtitle { font-size: 9pt; color: #374151; margin-top: 2pt; }
      .doc-title { font-size: 11pt; font-weight: bold; color: #111827; margin-top: 4pt; }
      .divider-double { height: 4pt; margin-top: 6pt; }
      .divider-double div { border-bottom: 1pt solid #111827; margin-bottom: 1pt; }

      .meta-info { font-size: 9pt; color: #374151; text-align: right; padding: 8pt 0; }

      .section { margin: 12px 0; }
      .section-header { background-color: #3d4f2a; color: white; padding:8px 12px; border-radius:4px; }

      .info-card { background:#f9fafb; border:1px solid #e5e7eb; padding:8px; margin-bottom:8px; border-radius:6px; }
      .data-grid td { padding:4px 0; vertical-align: top; border:none; font-size:10pt; }
      .data-label { color:#6b7280; font-weight:600; font-size:9pt; display:block; }
      .data-value { color:#111827; font-weight:600; margin-top:4px; display:block; }

      .styled-table { width:100%; border-collapse:collapse; font-size:9pt; margin:10px 0; }
      .styled-table th { background:#1f2937; color:white; padding:6px 6px; text-align:left; font-weight:bold; }
      .styled-table td { padding:6px 6px; border:1px solid #e5e7eb; }

      .badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:8pt; color:white; font-weight:bold; text-transform:uppercase; }
      .badge-green { background:#1f2937;} .badge-red { background:#dc2626; } .badge-amber { background:#d97706; } .badge-gray { background:#6b7280; }

      .financial-summary {  padding:2px; margin:10px 0; }
      .financial-row { display:table; width:100%; margin:4px 0; }
      .financial-row  div { display:table-cell; padding:4px 8px; }
      .financial-label { width:60%; font-weight:bold; color:#374151; }
      .financial-value { width:40%; text-align:right; font-weight:bold; color:#111827; font-size:11pt; }

      .record-block { page-break-inside: avoid; }
      .page-break-before { page-break-before: always; }

      /* firmas responsive */
      .firma-grid { display:grid; grid-template-columns: 1fr; gap:18px; text-align:center; }
      @media(min-width:768px){ .firma-grid { grid-template-columns: repeat(3, 1fr); } }
      .firma-img { height:50pt; width:auto; object-fit:contain; display:block; margin:0 auto 6px; }
      .no-firma { color:#6b7280; font-size:9pt; }
    </style>

    <div class="report report-body report-container bg-white rounded-lg shadow-sm">

      <!-- HEADER -->
      <table class="header-table">
        <tr>
          <td style="width:90pt; vertical-align: middle;">
            <img src="{% static 'src/img/logo.png' %}" alt="Logo" class="logo-img" />
          </td>

          <td style="vertical-align: middle; text-align: center;">
            <div class="company-title">EMBOTELLADORA NUDELPA LIMITADA</div>
            <div class="company-subtitle">Trinidad - Beni - Bolivia</div>
            <div class="doc-title">Orden de Trabajo</div>
            <div class="divider-double"><div></div><div></div></div>
          </td>

          <td style="width:90pt; vertical-align: middle; text-align:right;">
            <img src="{% static 'src/img/logoc.jpg' %}" alt="Logo" class="logo-img" />
          </td>
        </tr>
      </table>

      <div class="meta-info">
        <strong>Sant√≠sima Trinidad,</strong>
        {% if odt.creado_en %} {{ odt.creado_en|date:"j" }} de {{ odt.creado_en|date:"F" }} de {{ odt.creado_en|date:"Y" }}
        {% else %} {% now "j" %} de {% now "F" %} de {% now "Y" %} {% endif %}
        - <strong>Nudelpa/{{ odt.correlativo|stringformat:"04d" }}</strong>
      </div>

      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="flex items-center p-4 mb-4 rounded-xl border {% if message.tags == 'success' %}bg-emerald-50 border-emerald-200 text-emerald-800{% elif message.tags == 'error' %}bg-red-50 border-red-200 text-red-800{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %} shadow-sm transition-all animate-in fade-in slide-in-from-top-2">
        
        <div class="shrink-0">
          {% if message.tags == 'success' %}
            <svg class="h-5 w-5 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
          {% elif message.tags == 'error' %}
            <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            {% else %}
            <svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          {% endif %}
        </div>

        <div class="ml-3 font-medium text-sm">
          {{ message }}
        </div>

        <button type="button" onclick="this.parentElement.remove()" class="ml-auto -mx-1.5 -my-1.5 rounded-lg focus:ring-2 p-1.5 inline-flex h-8 w-8 hover:bg-black/5">
          <span class="sr-only">Cerrar</span>
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
      </div>
    {% endfor %}
  {% endif %}
</div>
      <!-- ESTADO Y ACCIONES -->
    <div class="rounded-2xl bg-linear-to-r from-slate-900 to-slate-700 text-white p-6 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm opacity-80">Estado actual</p>
          <h2 class="text-2xl font-bold">{{ odt.get_estado_display }}</h2>
        </div>
        
        <div class="flex gap-3 flex-wrap">
          <a href="{% url 'odt_detalle_pdf' odt.pk %}" target="_black"  class="bg-teal-500 px-4 py-3 rounded-xl ">Exportar PDF</a>
          <!-- Bot√≥n de edici√≥n general para supervisores -->
          {% if perms.controlodt.editar_completo_odt %}
            <a href="{% url 'odt_editar_general' odt.pk %}"
               class="h-11 px-5 py-2 rounded-xl bg-amber-500 text-white font-semibold hover:bg-amber-600 inline-flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
              </svg>
              Editar ODT
            </a>
          {% endif %}

          {% if odt.estado == 'BORRADOR' and odt.creado_por == request.user %}
            <a href="{% url 'odt_enviar_solicitud' odt.pk %}"
               class="h-11 px-5 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">
              Enviar a Solicitud
            </a>
          {% endif %}

          {% if odt.estado == 'SOLICITUD' %}
            <a href="{% url 'odt_asignar' odt.pk %}"
               class="h-11 px-5 py-2 rounded-xl bg-purple-600 text-white font-semibold hover:bg-purple-700">
              Asignar Responsable
            </a>
          {% endif %}

          {% if odt.estado == 'ASIGNADA' and odt.responsable_ejecucion == request.user %}
            <a href="{% url 'odt_iniciar' odt.pk %}"
               class="h-11 px-5 py-2 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700">
              Iniciar Ejecuci√≥n
            </a>
          {% endif %}

          {% if odt.estado == 'EN_EJECUCION' and odt.responsable_ejecucion == request.user %}
            <a href="{% url 'odt_ejecutar' odt.pk %}"
               class="h-11 px-5 py-2 rounded-xl bg-yellow-600 text-white font-semibold hover:bg-yellow-700">
              Completar Detalles
            </a>
            <a href="{% url 'odt_finalizar' odt.pk %}"
               class="h-11 px-5 py-2 rounded-xl bg-orange-600 text-white font-semibold hover:bg-orange-700">
              Finalizar y Enviar a Revisi√≥n
            </a>
          {% endif %}

          {% if odt.estado == 'RECHAZADA' and odt.responsable_ejecucion == request.user %}
            <a href="{% url 'odt_ejecutar' odt.pk %}"
               class="h-11 px-5 py-2 rounded-xl bg-yellow-600 text-white font-semibold hover:bg-yellow-700">
              Corregir y Reenviar
            </a>
          {% endif %}

          {% if odt.estado == 'REVISION' %}
            <a href="{% url 'odt_revisar' odt.pk %}"
               class="h-11 px-5 py-2 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">
              Revisar ODT
            </a>
          {% endif %}

          {% if odt.estado == 'APROBADA' %}
            <a href="{% url 'odt_aprobar_final' odt.pk %}"
               class="h-11 px-5 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">
              Aprobaci√≥n Final
            </a>
          {% endif %}
        </div>
      </div>
    </div>
      <!-- INFORMACI√ìN -->
      <div class="section record-block">
        <div style="font-weight:bold; font-size:12pt; margin-bottom:6px;">Informaci√≥n</div>

        <div class="info-card">
          <table class="data-grid" style="width:100%; border:none;">
            <tr>
              <td style="width:60%;">
                <span class="data-label">Fecha Emitida: {{ odt.fecha_programada|date:"d/m/Y H:i"|default:"‚Äî" }}</span>
               
              </td>

              <td style="width:40%; text-align:right;">
                <span class="data-label">N√∫mero ODT: {{ odt.n_odt|stringformat:"03d" }}</span>
            
              </td>
            </tr>

            <tr>
              <td>
                <span class="data-label">Prioridad: {{ odt.get_prioridad_display }}</span>
               
              </td>
              <td style="text-align:right;">
                <span class="data-label">Estado de proceso: {{ odt.get_estado_display }}</span>  
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <span class="data-label">Fallo: {{ odt.titulo }}</span>
                
              </td>
            </tr>
          </table>
        </div>
      </div>

      <!-- DATOS DEL EQUIPO -->
      <div class="section record-block">
        <div style="font-weight:bold; font-size:12pt; margin-bottom:6px;">Datos del Equipo</div>

        <div class="info-card">
          <table class="data-grid" style="width:100%; border:none;">
            <tr>
              <td>
                <span class="data-label">Ubicaci√≥n: {{ odt.tipo.nombre }}</span>
               
              </td>
               <td style="text-align:right;">
                <span class="data-label">C√≥digo: {{ odt.maquinaria.codigo }}</span>
                
              </td>
              
            </tr>

            <tr>
              <td>
                <span class="data-label">Equipo: {{ odt.maquinaria.nombre }}</span>
                
              </td>
             
            </tr>

           

            <tr>
              <td colspan="2">
                <span class="data-label">Descripci√≥n del fallo</span>
                <span class="data-value" style="font-weight:400;">{{ odt.descripcion }}</span>
              </td>
            </tr>
            <tr>
        <td colspan="2" style="padding-top: 15px;">
          {% if odt.archivo_informe %}
            <a href="{{ odt.archivo_informe.url }}" target="_blank" 
               style="display: inline-block; padding: 8px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
               üìÇ Ver Falla de equip√≥
            </a>
          {% else %}
            <span style="color: #dc3545; font-weight: bold; font-style: italic;">
              ‚ö†Ô∏è No tiene archivo Subido de fallo de equipo
            </span>
          {% endif %}
        </td>
      </tr>
          </table>
        </div>
      </div>

      <!-- INFORMACI√ìN GENERAL (resumen r√°pido, grid responsive) -->
      <div class="section record-block mt-4 ">
  <div class="font-bold text-base mb-2">Detalles</div>

  <div class="overflow-x-auto rounded-lg border border-neutral-200">
    <table class="min-w-full text-sm">
      <tbody class="divide-y divide-neutral-200">

        <tr>
          <td class="font-semibold bg-gray-50 px-3 py-2 w-1/3">
            Tipo de Trabajo
          </td>
          <td class="px-3 py-2">
            {{ odt.get_tipo_trabajo_display|default:"‚Äî" }}
          </td>
        </tr>

        <tr>
          <td class="font-semibold bg-gray-50 px-3 py-2">
            Solicitado por
          </td>
          <td class="px-3 py-2">
            {{ odt.creado_por.get_full_name|default:"‚Äî" }}
          </td>
        </tr>

        {% if odt.autorizado_por %}
        <tr>
          <td class="font-semibold bg-gray-50 px-3 py-2">
            Autorizado por
          </td>
          <td class="px-3 py-2">
            {{ odt.autorizado_por.get_full_name }}
          </td>
        </tr>
        {% endif %}

        {% if odt.responsable_ejecucion %}
        <tr>
          <td class="font-semibold bg-gray-50 px-3 py-2">
            Responsable Ejecuci√≥n
          </td>
          <td class="px-3 py-2">
            {{ odt.responsable_ejecucion.get_full_name }}
          </td>
        </tr>
        {% endif %}

        {% if odt.fecha_programada %}
        <tr>
          <td class="font-semibold bg-gray-50 px-3 py-2">
            Fecha Programada
          </td>
          <td class="px-3 py-2">
            {{ odt.fecha_programada|date:"d/m/Y H:i" }}
          </td>
        </tr>
        {% endif %}

      </tbody>
    </table>
  </div>
</div>


      <!-- DETALLES DE EJECUCI√ìN -->
      {% if odt.detalle_ejecucion %}
      <div class="section record-block mt-4">
        <div style="font-weight:bold; font-size:12pt; margin-bottom:6px;">Detalles de Ejecuci√≥n</div>

        {% with detalle=odt.detalle_ejecucion %}
        <div class="info-card">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <span class="data-label">Tipo de Falla</span>
              <span class="data-value">{{ detalle.get_falla_tipo_display }}</span>
            </div>

            <div>
              <span class="data-label">Ejecutado por</span>
              <span class="data-value">{{ detalle.ejecutado_por.get_full_name|default:"‚Äî" }}</span>
            </div>

            {% if detalle.hora_inicio_trabajo %}
            <div>
              <span class="data-label">Inicio Trabajo</span>
              <span class="data-value">{{ detalle.hora_inicio_trabajo|date:"d/m/Y H:i" }}</span>
            </div>
            {% endif %}

            {% if detalle.hora_fin_trabajo %}
            <div>
              <span class="data-label">Fin Trabajo</span>
              <span class="data-value">{{ detalle.hora_fin_trabajo|date:"d/m/Y H:i" }}</span>
            </div>
            {% endif %}
          </div>

          {% if detalle.descripcion_falla %}
          <div class="mt-4">
            <span class="data-label">Descripci√≥n de la Falla</span>
            <div class="mt-1 p-3 bg-white rounded-lg border border-neutral-200 text-sm">{{ detalle.descripcion_falla }}</div>
          </div>
          {% endif %}

          {% if detalle.tareas_realizadas %}
          <div class="mt-4">
            <span class="data-label">Tareas Realizadas</span>
            <div class="mt-1 p-3 bg-white rounded-lg border border-neutral-200 text-sm">{{ detalle.tareas_realizadas }}</div>
          </div>
          {% endif %}

          {% if detalle.medidas_seguridad %}
          <div class="mt-4">
            <span class="data-label">Medidas de Seguridad</span>
            <div class="mt-1 p-3 bg-white rounded-lg border border-neutral-200 text-sm">{{ detalle.medidas_seguridad }}</div>
          </div>
          {% endif %}

          {% if detalle.observaciones %}
          <div class="mt-4">
            <span class="data-label">Observaciones</span>
            <div class="mt-1 p-3 bg-white rounded-lg border border-neutral-200 text-sm">{{ detalle.observaciones }}</div>
          </div>
          {% endif %}
        </div>
        {% endwith %}
      </div>
      {% endif %}

      <!-- REPUESTOS -->
      {% if odt.repuestos.exists %}
      <div class="section record-block mt-4">
        <div style="font-weight:bold; font-size:12pt; margin-bottom:6px;">Repuestos Utilizados</div>

        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg overflow-hidden styled-table">
            <thead class="bg-neutral-200">
              <tr class="text-left text-sm">
                <th class="px-4 py-2">C√≥digo</th>
                <th class="px-4 py-2">Descripci√≥n</th>
                <th class="px-4 py-2">Cantidad</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-100">
              {% for rep in odt.repuestos.all %}
              <tr class="text-sm">
                <td class="px-4 py-2 w-40">{{ rep.codigo|default:"‚Äî" }}</td>
                <td class="px-4 py-2">{{ rep.descripcion }}</td>
                <td class="px-4 py-2 w-20">{{ rep.cantidad_utilizada }} Uni.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- PERSONAL -->
      {% if odt.personal_necesario.exists %}
      <div class="section record-block mt-4">
        <div style="font-weight:bold; font-size:12pt; margin-bottom:6px;">Personal Necesario</div>

        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg overflow-hidden styled-table">
            <thead class="bg-neutral-200">
              <tr class="text-left text-sm">
                <th class="px-4 py-2">Categor√≠a</th>
                <th class="px-4 py-2">Trabajador</th>
                <th class="px-4 py-2">Hrs.Trabajadas</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-100">
              {% for per in odt.personal_necesario.all %}
              <tr class="text-sm">
                <td class="px-4 py-2 w-40">{{ per.categoria|default:"‚Äî" }}</td>
                <td class="px-4 py-2 ">{{ per.trabajador|default:"‚Äî" }}</td>
                <td class="px-4 py-2 w-30 text-right">{{ per.horas_trabajadas }} hrs.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- FIRMAS -->
      <div class="section record-block mt-6">
        <h3 style="font-weight:bold; font-size:12pt; margin-bottom:8px;">Personal Involucrado y Firmas</h3>

        <div class="firma-grid">
          <!-- Realizado por -->
          <div>
            {% if odt.creado_por %}
              {% if odt.creado_por.firma %}
                <img class="firma-img" src="{{ odt.creado_por.firma.url }}" alt="Firma Realizado">
              {% else %}
                <p class="no-firma">Firma no registrada</p>
              {% endif %}
              <div style="font-size:9pt; margin-top:6px;">Realizado por
                {% for g in odt.creado_por.groups.all %}{{ g.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
              </div>
              <div style="font-size:10pt; font-weight:600;">{{ odt.creado_por.get_full_name }}</div>
            {% else %}
              <p class="no-firma">No asignado</p>
            {% endif %}
          </div>

          <!-- Revisado por -->
          <div>
            {% if odt.revisado_por %}
              {% if odt.revisado_por.firma %}
                <img class="firma-img" src="{{ odt.revisado_por.firma.url }}" alt="Firma Revisado">
              {% else %}
                <p class="no-firma">Firma no registrada</p>
              {% endif %}
              <div style="font-size:9pt; margin-top:6px;">Revisado por
                {% for g in odt.revisado_por.groups.all %}{{ g.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
              </div>
              <div style="font-size:10pt; font-weight:600;">{{ odt.revisado_por.get_full_name }}</div>
            {% else %}
              <p class="no-firma">Pendiente de revisi√≥n</p>
            {% endif %}
          </div>

          <!-- Aprobado por -->
          <div>
            {% if odt.aprobado_por %}
              {% if odt.aprobado_por.firma %}
                <img class="firma-img" src="{{ odt.aprobado_por.firma.url }}" alt="Firma Aprobado">
              {% else %}
                <p class="no-firma">Firma no registrada</p>
              {% endif %}
              <div style="font-size:9pt; margin-top:6px;">Aprobado por
                {% for g in odt.aprobado_por.groups.all %}{{ g.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
              </div>
              <div style="font-size:10pt; font-weight:600;">{{ odt.aprobado_por.get_full_name }}</div>
            {% else %}
              <p class="no-firma">Pendiente de aprobaci√≥n</p>
            {% endif %}
          </div>
        </div>

      </div>

    </div>
  </div>
</section>
{% endblock %}
